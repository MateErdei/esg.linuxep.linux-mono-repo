<?xml version="1.0" encoding="utf-8"?>
<package
  name="sdds3"
  version="1.0.0">
    <inputs>
        <workingdir>.</workingdir>

        <build-asset project="winep" repo="sau">
            <!-- Import a specific release version of SDDS3 tools, because we don't want the sdds3 repo rebuilding for each SAU build. -->
            <release-version branch="release--LINUXDAR-2022-12" build-id="20220302174339-8b76fb6e86387f1129318420fa531163b0fcb708-AM08eB"/>
            <include artifact-path="Linux-x64/SDDS3-Utils" dest-dir="redist/sdds3"/>
        </build-asset>
        <build-asset project="em" repo="esg">
            <release-version branch="release/bazeltools" build-id="20220209132531-8fe21319f1312c7db02ef2c8f0a2750603df2f54-LvLU7i"/>
            <include artifact-path="bazel-tools" dest-dir="." />
        </build-asset>
        <!-- gcc -->
        <trusted-asset artifact-path="filer5-migrate/gcclinux/8-1-0-43/213047/gcclinux/gcc-8.1.0-linux.tar.gz" dest-dir="redist/gcc"/>
        <trusted-asset artifact-path="filer5-migrate/sddsimportgen/1-0-12/214456/sddsimportgen" dest-dir="./linuxep_suites"/>

        <build-asset project="linuxep" repo="everest-base">
            <development-version branch="develop"/>
            <include artifact-path="sspl-base/SDDS3-PACKAGE" dest-dir="redist/base/latest/x64" mode="dev"/>
            <include artifact-path="sspl-base-999/SDDS3-PACKAGE" dest-dir="redist/base/latest/x64" mode="999"/>
        </build-asset>

        <build-asset project="linuxep" repo="capsule8-sensor">
            <development-version branch="master"/>
            <include artifact-path="SDDS3-PACKAGE" dest-dir="redist/runtimedetections/latest/x64" mode="dev"/>
            <include artifact-path="SDDS3-COMPONENT-999" dest-dir="redist/runtimedetections/latest/x64" mode="999"/>
        </build-asset>

        <build-asset project="winep" repo="liveterminal">
            <development-version branch="develop"/>
            <include artifact-path="liveterminal/SDDS3-PACKAGE" dest-dir="redist/liveresponse/latest/x64" mode="dev"/>
            <include artifact-path="liveterminal-999/SDDS3-PACKAGE" dest-dir="redist/liveresponse/latest/x64" mode="999"/>
        </build-asset>

        <build-asset project="linuxep" repo="sspl-plugin-edr-component">
            <development-version branch="develop"/>
            <include artifact-path="edr/SDDS3-PACKAGE" dest-dir="redist/edr/latest/x64" mode="dev"/>
            <include artifact-path="edr-999/SDDS3-PACKAGE" dest-dir="redist/edr/latest/x64" mode="999"/>
        </build-asset>

        <build-asset project="linuxep" repo="sspl-plugin-event-journaler">
            <development-version branch="develop"/>
            <include artifact-path="eventjournaler/SDDS3-PACKAGE" dest-dir="redist/event-journaler/latest/x64" mode="dev"/>
            <include artifact-path="eventjournaler-999/SDDS3-PACKAGE" dest-dir="redist/event-journaler/latest/x64" mode="999"/>
        </build-asset>

        <build-asset project="linuxep" repo="sspl-plugin-mdr-component">
            <development-version branch="develop"/>
            <include artifact-path="mdr/SDDS3-PACKAGE" dest-dir="redist/mdr/latest/x64" mode="dev"/>
            <include artifact-path="mdr-999/SDDS3-PACKAGE" dest-dir="redist/mdr/latest/x64" mode="999"/>
        </build-asset>

        <build-asset project="linuxep" repo="sspl-plugin-anti-virus">
            <development-version branch="develop"/>
            <include artifact-path="sspl-plugin-anti-virus/SDDS3-PACKAGE" dest-dir="redist/av/latest/x64" mode="dev"/>
            <include artifact-path="sspl-plugin-anti-virus-999/SDDS3-PACKAGE" dest-dir="redist/av/latest/x64" mode="999"/>
        </build-asset>
        <build-asset project="linuxep" repo="sspl-plugin-heartbeat">
            <development-version branch="develop"/>
            <include artifact-path="sspl-plugin-heartbeat/SDDS3-PACKAGE" dest-dir="redist/heartbeat/latest/x64" mode="dev"/>
            <include artifact-path="sspl-plugin-heartbeat-999/SDDS3-PACKAGE" dest-dir="redist/heartbeat/latest/x64" mode="999"/>
        </build-asset>


        <!-- Supplements -->
        <build-asset project="em" repo="esg">
            <release-version branch="release/scheduled_query_pack/1.8" build-id="20211130093048-3f0a191b04d3cc712f00bb795506227fbe0c2882-UqYeJA"/>
<!--            TODO - LINUXDAR-4877 revert to develop -->
            <development-version branch="release--scheduled_query_pack--1.11" build-id="20220426094343-e5593df4275b7d0b7ebd145e869e41668200806e-NAJJSV"/>
            <include artifact-path="scheduled-query-pack-scit" dest-dir="inputs/supplements/scheduled-query-pack"/>
        </build-asset>
        <build-asset project="linuxep" repo="sspl-flags">
            <release-version branch="release/DNR-SDDS3-Test" build-id="20220307130309-f04b9f8a5a0acab1b8e03615647f95d0ba0fed67-XFyLrY"/>
            <development-version branch="develop"/>
            <include artifact-path="sspl-flags/scit-supplement" dest-dir="inputs/supplements/sspl-flags"/>
        </build-asset>
        <build-asset project="linuxep" repo="capsule8-sensor">
            <release-version branch="release/DNR-2022-09-SDDS3-Test" build-id="20220304101156-b59c655eaecd56ac569c6286a1cdecee2778e74b-TEXz6J"/>
            <development-version branch="master"/>
            <include artifact-path="sspl-rdrules-scit" dest-dir="inputs/supplements/RuntimeDetectionRules"/>
        </build-asset>
    </inputs>

    <buildcommands>
        <command>
            <program>env</program>
            <workingdir>.</workingdir>
        </command>
        <command>
            <program>python3</program>
            <args>makesuites.py</args>
            <workingdir>./linuxep_suites</workingdir>
        </command>
        <command>
            <program>chmod</program>
            <args>+x redist/sdds3/sdds3-builder</args>
            <workingdir>.</workingdir>
        </command>
        <command>
            <program>python3</program>
            <args>-u tools/src/dump_environment/dump_environment.py</args>
            <workingdir>.</workingdir>
        </command>
        <command mode="dev,999">
            <program>python3</program>
            <args>-u sdds3/tools/gen_bazel.py</args>
            <workingdir>.</workingdir>
        </command>
        <command mode="prod">
            <program>python3</program>
            <args>-u sdds3/tools/gen_bazel.py --mode prod</args>
            <workingdir>.</workingdir>
        </command>
        <command>
            <program>bazel</program>
            <args>build //sdds3/... --verbose_failures --spawn_strategy=standalone --distdir /opt/distdir</args>
            <workingdir>.</workingdir>
        </command>
    </buildcommands>

    <publish>

        <!--dev version-->
        <build-asset artifact-path="sdds3-repo" source-dir="bazel-out/k8-fastbuild/bin/sdds3" mode="dev">
            <include glob="package/**"/>
            <include glob="suite/**"/>
            <include glob="supplement/**"/>
            <include glob="supplement_package/**"/>
        </build-asset>
        <release-asset artifact-path="sdds3-launchdarkly" source-dir="output/launchdarkly" mode="dev">
            <include glob="*.json"/>
        </release-asset>
        <!--999 version-->
        <build-asset artifact-path="sdds3-repo-999" source-dir="bazel-out/k8-fastbuild/bin/sdds3" mode="999">
            <include glob="package/**"/>
            <include glob="suite/**"/>
            <include glob="supplement/**"/>
            <include glob="supplement_package/**"/>
        </build-asset>
        <release-asset artifact-path="sdds3-launchdarkly-999" source-dir="output/launchdarkly" mode="999">
            <include glob="*.json"/>
        </release-asset>
        <!--prod version-->
        <release-asset artifact-path="prod-sdds3-repo" source-dir="bazel-out/k8-fastbuild/bin/sdds3" mode="prod">
            <include glob="package/**"/>
            <include glob="suite/**"/>
        </release-asset>
        <release-asset artifact-path="prod-sdds3-launchdarkly" source-dir="output/launchdarkly" mode="prod">
            <include glob="*.json"/>
        </release-asset>

    </publish>

</package>