<?xml version="1.0" encoding="utf-8"?>
<package
  name="sdds3"
  version="1.0.0">
    <inputs>
        <workingdir>.</workingdir>

        <build-asset project="winep" repo="sau">
            <!-- Import a specific release version of SDDS3 tools, because we don't want the sdds3 repo rebuilding for each SAU build. -->
            <release-version branch="release/WINEP-2022.09" build-id="20220209235229-033dd8f5191e85fd84cfe2f974f0295fd0304ee1-WdQV7w"/>
            <include artifact-path="Linux-x64/SDDS3-Utils" dest-dir="redist/sdds3"/>
        </build-asset>
        <build-asset project="em" repo="esg">
            <release-version branch="release/bazeltools" build-id="20220209132531-8fe21319f1312c7db02ef2c8f0a2750603df2f54-LvLU7i"/>
            <include artifact-path="bazel-tools" dest-dir="." />
        </build-asset>
        <!-- gcc -->
        <trusted-asset artifact-path="filer5-migrate/gcclinux/8-1-0-43/213047/gcclinux/gcc-8.1.0-linux.tar.gz" dest-dir="redist/gcc"/>

        <build-asset project="linuxep" repo="everest-base" >
            <release-version branch="release--Version_1_1_9" build-id="20220111115616-63e343f79cd351f4b766d0f4697fff50969105d6-T8rvVv"/>
            <include artifact-path="sspl-base/SDDS-COMPONENT" dest-dir="redist/package/sspl-base"/>
        </build-asset>

        <build-asset project="linuxep" repo="capsule8-sensor" >
            <release-version branch="release--version_4_10_0" build-id="20220202230147-153c90b52dfc3e9d3c40d151c789bfd00b38f5c5-I9yzI3"/>
            <include artifact-path="SDDS-COMPONENT" dest-dir="redist/package/runtimedetections"/>
        </build-asset>

<!--        commented out due to not being in integr8 phase 2-->
<!--        <build-asset project="linuxep" repo="sspl-plugin-heartbeat" >-->
<!--            <development-version branch="develop"/>-->
<!--            <include artifact-path="sspl-plugin-heartbeat/SDDS-COMPONENT" dest-dir="redist/package/sspl-plugin-heartbeat"/>-->
<!--        </build-asset>-->

        <build-asset project="winep" repo="liveterminal" >
            <release-version branch="release--version_1_5_1" build-id="20220113114734-2e0533633cdcbb4bd71c63f90217793804a2ed27-1IE4Bn" />
            <include artifact-path="liveterminal/sdds" dest-dir="redist/package/liveterminal"/>
        </build-asset>

        <build-asset project="linuxep" repo="sspl-plugin-edr-component">
            <development-version branch="feature/LINUXDAR-4179-setup-warehouse-packaging-of-sdds3-files"/>
            <include artifact-path="edr/SDDS3-PACKAGE" dest-dir="redist/edr/latest/x64"/>
        </build-asset>

        <build-asset project="linuxep" repo="sspl-plugin-event-journaler">
            <release-version branch="release--version_1_0_1" build-id="20220112090118-a0b366a56367125c50b912ae16bdd69b1ba5b3ed-2pHh1A"/>
            <include artifact-path="eventjournaler/SDDS-COMPONENT" dest-dir="redist/package/sspl-plugin-event-journaler"/>
        </build-asset>
        <build-asset project="linuxep" repo="sspl-plugin-mdr-componentsuite">
            <release-version branch="release--version_1_0_11" build-id="20220113170647-2046b6949bdddaaaab2ea763e98caae45ce778f0-X1b4m9"/>
            <include artifact-path="output/SDDS-SSPL-DBOS-COMPONENT" dest-dir="redist/package/sspl-plugin-mdr-componentsuite/SDDS-SSPL-DBOS-COMPONENT"/>
            <include artifact-path="output/SDDS-SSPL-MDR-COMPONENT" dest-dir="redist/package/sspl-plugin-mdr-componentsuite/SDDS-SSPL-MDR-COMPONENT"/>
            <include artifact-path="output/SDDS-SSPL-MDR-COMPONENT-SUITE" dest-dir="redist/package/sspl-plugin-mdr-componentsuite/SDDS-SSPL-MDR-COMPONENT-SUITE"/>
        </build-asset>

        <build-asset project="linuxep" repo="sspl-plugin-anti-virus">
            <release-version branch="release--version_1_0_5" build-id="20220113110146-e13148f3347ef1dc284d5d2b955dadd3dfb8a049-1i4fP3"/>
            <include artifact-path="sspl-plugin-anti-virus/SDDS-COMPONENT" dest-dir="redist/package/sspl-plugin-anti-virus"/>
        </build-asset>

        <build-asset project="em" repo="esg">
            <development-version branch="develop"/>
            <release-version branch="release/scheduled_query_pack/1.8" build-id="20211130093048-3f0a191b04d3cc712f00bb795506227fbe0c2882-UqYeJA"/>
            <include artifact-path="scheduled-query-pack-scit" dest-dir="inputs/supplements/scheduled-query-pack"/>
        </build-asset>
    </inputs>

    <buildcommands>
        <command>
            <program>chmod</program>
            <args>+x redist/sdds3/sdds3-builder</args>
            <workingdir>.</workingdir>
        </command>
        <command>
            <program>python3</program>
            <args>-u tools/src/dump_environment/dump_environment.py</args>
            <workingdir>.</workingdir>
        </command>
        <command mode="dev">
            <program>python3</program>
            <args>-u sdds3/tools/gen_bazel.py</args>
            <workingdir>.</workingdir>
        </command>
        <command mode="prod">
            <program>python3</program>
            <args>-u sdds3/tools/gen_bazel.py --mode prod</args>
            <workingdir>.</workingdir>
        </command>
        <command>
            <program>bazel</program>
            <args>build //sdds3/... --verbose_failures</args>
            <workingdir>.</workingdir>
        </command>
    </buildcommands>

    <publish>

        <!--dev version-->
<!--        <build-asset artifact-path="sdds3-repo" source-dir="output\repo" mode="dev"/>-->
<!--        <build-asset artifact-path="sdds3-launchdarkly" source-dir="output\launchdarkly" mode="dev"/>-->
        <!--prod version-->
        <release-asset artifact-path="prod-sdds3-repo" source-dir="output/repo">
            <include glob="package/**"/>
            <include glob="suite/**"/>
        </release-asset>
        <release-asset artifact-path="prod-sdds3-launchdarkly" source-dir="output/launchdarkly">
            <include glob="*.json"/>
        </release-asset>
    </publish>

</package>