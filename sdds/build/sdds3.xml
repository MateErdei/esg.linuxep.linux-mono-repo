<?xml version="1.0" encoding="utf-8"?>
<package
  name="sdds3"
  version="1.0.0">
    <inputs>
        <workingdir>.</workingdir>

        <build-asset project="winep" repo="sau">
            <!-- Import a specific release version of SDDS3 tools, because we don't want the sdds3 repo rebuilding for each SAU build. -->
            <release-version branch="release/WINEP-2022.09" build-id="20220209235229-033dd8f5191e85fd84cfe2f974f0295fd0304ee1-WdQV7w"/>
            <include artifact-path="Linux-x64/SDDS3-Utils" dest-dir="redist/sdds3"/>
        </build-asset>
        <build-asset project="em" repo="esg">
            <release-version branch="release/bazeltools" build-id="20220209132531-8fe21319f1312c7db02ef2c8f0a2750603df2f54-LvLU7i"/>
            <include artifact-path="bazel-tools" dest-dir="." />
        </build-asset>
        <!-- gcc -->
        <trusted-asset artifact-path="filer5-migrate/gcclinux/8-1-0-43/213047/gcclinux/gcc-8.1.0-linux.tar.gz" dest-dir="redist/gcc"/>
        <trusted-asset artifact-path="filer5-migrate/sddsimportgen/1-0-12/214456/sddsimportgen" dest-dir="./linuxep_suites"/>

        <build-asset project="linuxep" repo="everest-base" >
            <development-version branch="feature/LINUXDAR-4179-setup-warehouse-packaging-of-sdds3-files"/>
            <include artifact-path="sspl-base/SDDS3-PACKAGE" dest-dir="redist/base/latest/x64"/>
        </build-asset>

        <build-asset project="linuxep" repo="capsule8-sensor" >
            <development-version branch="feature/LINUXDAR-4179-sdds3"/>
            <include artifact-path="SDDS3-PACKAGE" dest-dir="redist/runtimedetections/latest/x64"/>
        </build-asset>

<!--        commented out due to not being in integr8 phase 2-->
<!--        <build-asset project="linuxep" repo="sspl-plugin-heartbeat" >-->
<!--            <development-version branch="develop"/>-->
<!--            <include artifact-path="sspl-plugin-heartbeat/SDDS-COMPONENT" dest-dir="redist/package/sspl-plugin-heartbeat"/>-->
<!--        </build-asset>-->

        <build-asset project="winep" repo="liveterminal" >
            <development-version branch="feature/LINUXDAR-4179-setup-warehouse-packaging-of-sdds3-files"/>
            <include artifact-path="liveterminal/SDDS3-PACKAGE" dest-dir="redist/liveresponse/latest/x64"/>
        </build-asset>

        <build-asset project="linuxep" repo="sspl-plugin-edr-component">
            <development-version branch="feature/LINUXDAR-4179-setup-warehouse-packaging-of-sdds3-files"/>
            <include artifact-path="edr/SDDS3-PACKAGE" dest-dir="redist/edr/latest/x64"/>
        </build-asset>

        <build-asset project="linuxep" repo="sspl-plugin-event-journaler">
            <development-version branch="feature/LINUXDAR-4179-setup-warehouse-packaging-of-sdds3-files"/>
            <include artifact-path="eventjournaler/SDDS3-PACKAGE" dest-dir="redist/event-journaler/latest/x64"/>
        </build-asset>
        <build-asset project="linuxep" repo="sspl-plugin-mdr-componentsuite">
            <release-version branch="release--version_1_0_11" build-id="20220113170647-2046b6949bdddaaaab2ea763e98caae45ce778f0-X1b4m9"/>
            <include artifact-path="output/SDDS-SSPL-DBOS-COMPONENT" dest-dir="redist/package/sspl-plugin-mdr-componentsuite/SDDS-SSPL-DBOS-COMPONENT"/>
            <include artifact-path="output/SDDS-SSPL-MDR-COMPONENT" dest-dir="redist/package/sspl-plugin-mdr-componentsuite/SDDS-SSPL-MDR-COMPONENT"/>
            <include artifact-path="output/SDDS-SSPL-MDR-COMPONENT-SUITE" dest-dir="redist/package/sspl-plugin-mdr-componentsuite/SDDS-SSPL-MDR-COMPONENT-SUITE"/>
        </build-asset>

        <build-asset project="linuxep" repo="sspl-plugin-mdr-component">
            <development-version branch="feature/LINUXDAR-4179-setup-warehouse-packaging-of-sdds3-files"/>
            <include artifact-path="mdr/SDDS3-PACKAGE" dest-dir="redist/mdr/latest/x64"/>
        </build-asset>

        <build-asset project="linuxep" repo="sspl-plugin-anti-virus">
            <development-version branch="feature/LINUXDAR-4179-setup-warehouse-packaging-of-sdds3-files"/>
            <include artifact-path="sspl-plugin-anti-virus/SDDS3-PACKAGE" dest-dir="redist/av/latest/x64"/>
        </build-asset>
        <build-asset project="linuxep" repo="sspl-plugin-heartbeat">
            <development-version branch="feature/LINUXDAR-4179-setup-warehouse-packaging-of-sdds3-files"/>
            <include artifact-path="sspl-plugin-heartbeat/SDDS3-PACKAGE" dest-dir="redist/heartbeat/latest/x64"/>
        </build-asset>



        <build-asset project="em" repo="esg">
            <development-version branch="develop"/>
            <release-version branch="release/scheduled_query_pack/1.8" build-id="20211130093048-3f0a191b04d3cc712f00bb795506227fbe0c2882-UqYeJA"/>
            <include artifact-path="scheduled-query-pack-scit" dest-dir="inputs/supplements/scheduled-query-pack"/>
        </build-asset>
        <build-asset project="linuxep" repo="sspl-flags">
            <development-version branch="feature/LINUXDAR-4181-sdds3ify"/>
            <include artifact-path="sspl-flags/scit-supplement" dest-dir="inputs/supplements/sspl-flags"/>
        </build-asset>
        <build-asset project="linuxep" repo="capsule8-sensor">
            <development-version branch="jm/SDDS3-supplement"/>
            <include artifact-path="sspl-rdrules-scit" dest-dir="inputs/supplements/RuntimeDetectionRules"/>
        </build-asset>
    </inputs>

    <buildcommands>
        <command>
            <program>chmod</program>
            <args>+x redist/sdds3/sdds3-builder</args>
            <workingdir>.</workingdir>
        </command>
        <command>
            <program>python3</program>
            <args>-u tools/src/dump_environment/dump_environment.py</args>
            <workingdir>.</workingdir>
        </command>
        <command mode="dev">
            <program>python3</program>
            <args>-u sdds3/tools/gen_bazel.py</args>
            <workingdir>.</workingdir>
        </command>
        <command mode="prod">
            <program>python3</program>
            <args>-u sdds3/tools/gen_bazel.py --mode prod</args>
            <workingdir>.</workingdir>
        </command>
        <command>
            <program>bazel</program>
            <args>build //sdds3/... --verbose_failures --spawn_strategy=standalone</args>
            <workingdir>.</workingdir>
        </command>
    </buildcommands>

    <publish>

        <!--dev version-->
<!--        <build-asset artifact-path="sdds3-repo" source-dir="output\repo" mode="dev"/>-->
<!--        <build-asset artifact-path="sdds3-launchdarkly" source-dir="output\launchdarkly" mode="dev"/>-->
        <!--prod version-->
        <release-asset artifact-path="sdds3-repo" source-dir="bazel-out/k8-fastbuild/bin/sdds3">
            <include glob="package/**"/>
            <include glob="suite/**"/>
        </release-asset>
        <release-asset artifact-path="sdds3-launchdarkly" source-dir="output/launchdarkly">
            <include glob="*.json"/>
        </release-asset>
    </publish>

</package>