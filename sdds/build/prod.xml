<?xml version="1.0" encoding="utf-8"?>
<package
  name="prod"
  version="1.0.0">

  <inputs>
    <workingdir>.</workingdir>
    <intermediate artifact-path="winep_suites/SDDS-Ready-Packages" dest-dir="inputs/winep_suites" />

    <!-- SDDS3 tools -->
    <build-asset project="winep" repo="sau">
      <!-- Import a specific release version of SDDS3 tools, because we don't want the sdds3 repo rebuilding for each SAU build. -->
      <release-version branch="release/WINEP-2020.50" build-id="20201202180116-3a25f1f62022a8930a63d58db3b8569f23da2c66-b6fq12"/>
      <include artifact-path="Release-x64/SDDS3-Utils" dest-dir="inputs/sdds3"/>
    </build-asset>
    <!-- SDDS3 tools end -->

    <!-- Bazel tools -->
    <build-asset project="em" repo="esg">
      <!-- release-version fetches for all branches with no development-version -->
      <release-version branch="release/tools" build-id="20200922012353-73687b4ea6c47f3c1737d3f983308783165fefb9-r0lxP5"/>
      <include artifact-path="bazel-tools" dest-dir="." />
    </build-asset>
    <!-- Bazel tools end -->

  </inputs>

  <buildcommands>
    <command>
      <program>cmd.exe</program>
      <args>/c py -3 -u tools/src/dump_environment/dump_environment.py</args>
      <workingdir>.</workingdir>
    </command>
    <command>
      <program>cmd.exe</program>
      <args>/c py -3 -u sdds3/tools/prep_prod.py</args>
      <workingdir>.</workingdir>
    </command>
    <command>
      <program>bazel</program>
      <args>build //sdds3/... --verbose_failures %CI_BAZEL_CACHE_PARAMS_V1%</args>
      <workingdir>.</workingdir>
    </command>
  </buildcommands>

  <publish>
    <release-asset artifact-path="prod-sdds3-repo" source-dir="bazel-out/x64_windows-fastbuild/bin/sdds3">
      <include glob="package/**"/>
      <include glob="suite/**"/>
    </release-asset>
    <release-asset artifact-path="prod-sdds3-launchdarkly" source-dir="output/launchdarkly">
      <include glob="*.json"/>
    </release-asset>
    <release-asset artifact-path="prod-ballista-specs" source-dir="output/specs">
      <include glob="**/*.xml"/>
    </release-asset>
  </publish>

  <signingexclusions>
    <!-- ENCRYPTION package -->
    <promotedfile name="Castle.Core.dll"/>
    <promotedfile name="FluentNHibernate.dll"/>
    <promotedfile name="Iesi.Collections.dll"/>
    <promotedfile name="log4net.dll"/>
    <promotedfile name="NHibernate.dll"/>
    <promotedfile name="Ninject.dll"/>
    <promotedfile name="Ninject.Extensions.Factory.dll"/>
    <promotedfile name="Ninject.Extensions.NamedScope.dll"/>
    <promotedfile name="System.Data.SQLite.dll"/>
    <promotedfile name="SQLite.Interop.dll"/>
    <!-- SophosFIM package -->
    <promotedfile name="SophosFIM.db"/>
    <!-- CRT -->
    <promotedfile name="msvcm90.dll"/>
  </signingexclusions>
</package>
