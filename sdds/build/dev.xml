<?xml version="1.0" encoding="utf-8"?>
<package name="sspl-warehouse" version="1.0.0">
    <!-- Components are fetched directly by the warehouse generation scripts according to the specs in the
         warehouse definition file. These inputs are the tools that are needed and a couple of oddball
         components.

         All modes:
            dev
            prod
            999
    -->

    <inputs>
        <workingdir>.</workingdir>
        
        <!-- Base -->
        <intermediate artifact-path="base/linux_x64_rel/installer" dest-dir="sdds/redist/base/latest/x64" mode="dev,prod,999"/>
        <intermediate artifact-path="base/linux_x64_rel/system_test" dest-dir="sdds"/>
        <intermediate artifact-path="base/linux_arm64_rel/installer" dest-dir="sdds/redist/base/latest/arm64" mode="dev,prod,999"/>
        <intermediate artifact-path="base/linux_arm64_rel/system_test" dest-dir="sdds"/>

        <!-- Response Action -->
        <intermediate artifact-path="response_actions/linux_x64_rel/installer" dest-dir="sdds/redist/responseactions/latest/x64" mode="dev,prod,999"/>
        <intermediate artifact-path="response_actions/linux_arm64_rel/installer" dest-dir="sdds/redist/responseactions/latest/arm64" mode="dev,prod,999"/>

        <!-- EDR -->
        <intermediate artifact-path="edr/linux_x64_rel/installer" dest-dir="sdds/redist/edr/latest/x64" mode="dev,prod,999"/>
        <intermediate artifact-path="edr/linux_arm64_rel/installer" dest-dir="sdds/redist/edr/latest/arm64" mode="dev,prod,999"/>
        <!-- Event Journaler -->
        <intermediate artifact-path="eventjournaler/linux_x64_rel/installer" dest-dir="sdds/redist/event-journaler/latest/x64" mode="dev,prod,999"/>
        <intermediate artifact-path="eventjournaler/linux_arm64_rel/installer" dest-dir="sdds/redist/event-journaler/latest/arm64" mode="dev,prod,999"/>
        <!-- AV -->
        <intermediate artifact-path="av/linux_x64_rel/installer" dest-dir="sdds/redist/av/latest/x64" mode="dev,prod,999"/>
        <intermediate artifact-path="av/linux_arm64_rel/installer" dest-dir="sdds/redist/av/latest/arm64" mode="dev,prod,999"/>

        <!-- Live Response -->
        <intermediate artifact-path="liveterminal/linux_x64_rel/installer" dest-dir="sdds/redist/liveresponse/latest/x64" mode="dev,prod,999"/>
        <intermediate artifact-path="liveterminal/linux_arm64_rel/installer" dest-dir="sdds/redist/liveresponse/latest/arm64" mode="dev,prod,999"/>

        <build-asset project="linuxep" repo="runtimedetections" mode="dev,999">
            <development-version branch="develop"/>
            <include artifact-path="SDDS-COMPONENT" dest-dir="sdds/redist/runtimedetections/latest/x64" mode="dev,999"/>
            <include artifact-path="SDDS-COMPONENT-arm64" dest-dir="sdds/redist/runtimedetections/latest/arm64" mode="dev,999"/>
        </build-asset>


        <!--supplements-->
        <build-asset project="linuxep" repo="runtimedetections" mode="dev,999,prod">
            <release-version branch="release--content--version_5_6_0" build-id="20231010171805-bd2c97393e762f88a844399575f30283d76ec446-gCkDF5"/>
            <include artifact-path="sspl-rdrules-scit" dest-dir="sdds/inputs/supplements/RuntimeDetectionRules"/>
        </build-asset>
        <build-asset project="em" repo="esg" >
            <release-version branch="release/scheduled_query_pack/1.13" build-id="20220824140550-05ec7c0da54e978fa40839ee052374983a4a057a-JbkaIM"/>
            <development-version branch="develop" />
            <include artifact-path="scheduled-query-pack-scit" dest-dir="sdds/inputs/supplements/scheduled-query-pack" mode="dev,prod,999"/>
        </build-asset>
        <build-asset project="linuxep" repo="sspl-flags">
            <release-version branch="release/2023-4" build-id="20231107103135-3ad7197a39740d52dc6d557aa0a121f2e9421125-aRq3QY"/>
            <development-version branch="develop" />
            <include artifact-path="sspl-flags/scit-supplement" dest-dir="sdds/inputs/supplements/sspl-flags" mode="dev,999,prod"/>
        </build-asset>

        <build-asset project="em" repo="esg">
            <release-version branch="release/SPRINT-2023.37-linux"
                             build-id="20230908150721-2a0223e80f68f92a13cf494ec53ad2f70eb6d01e-jQCcwz"/>
            <development-version branch="develop"/>
            <include artifact-path="bazel-tools" dest-dir="sdds"/>
            <include artifact-path="sophlib/BUILD" dest-dir="sdds/common/sophlib"/>
            <include artifact-path="sophlib/include" dest-dir="sdds/common/sophlib/include/sophlib"/>
            <include artifact-path="sophlib/linux_x64_rel/lib" dest-dir="sdds/common/sophlib/linux_x64_release/lib"/>
            <include artifact-path="sophlib/linux_x64_rel/sdds3_tools" dest-dir="sdds/imports/internal/sdds3_utils"/>
        </build-asset>

        <!-- gcc -->
        <build-asset project="thirdparty" repo="gcc">
            <release-version branch="release/Version_11_2_0" build-id="20220310091547-cf8f7ca9572a3bc9a68f05138086815341a49224-cZ84iF"/>
            <include artifact-path="output" dest-dir="sdds/redist/gcc" mode="dev,999,prod"/>
        </build-asset>
    </inputs>

    <buildcommands>
        <!-- Clear the output directory for the packages/suites, so that old ones are not left around, which can cause
            problems with tests -->
        <command mode="dev,999,prod">
            <program>rm</program>
            <args>-rf bazel-bin/sdds3</args>
            <workingdir>.</workingdir>
        </command>
        <command mode="dev,999,prod">
            <program>python3</program>
            <args>makesuites.py</args>
            <workingdir>./sdds/linuxep_suites</workingdir>
        </command>
        <command mode="dev,999,prod">
            <program>/bin/bash</program>
            <args>./fixup_bazel_tools.sh</args>
            <workingdir>./sdds</workingdir>
        </command>
        <command mode="dev,999,prod">
            <program>python3</program>
            <args>-u tools/src/dump_environment/dump_environment.py</args>
            <workingdir>./sdds</workingdir>
        </command>
        <command mode="dev,999,prod">
            <program>mv</program>
            <args>tools/environment.json imports/environment.json</args>
            <workingdir>./sdds</workingdir>
        </command>
        <command mode="dev">
            <program>python3</program>
            <args>-u sdds3/tools/gen_bazel.py --mode dev</args>
            <workingdir>./sdds</workingdir>
        </command>
        <command mode="999">
            <program>python3</program>
            <args>-u sdds3/tools/gen_bazel.py --mode 999</args>
            <workingdir>./sdds</workingdir>
        </command>
        <command mode="prod">
            <program>python3</program>
            <args>-u sdds3/tools/gen_bazel.py --mode prod</args>
            <workingdir>./sdds</workingdir>
        </command>
        <command mode="dev,999,prod">
            <program>bazel</program>
            <args>build //sdds3/... --verbose_failures --spawn_strategy=standalone --distdir /opt/distdir</args>
            <workingdir>./sdds</workingdir>
        </command>
    </buildcommands>

  <publish>
      <!--dev version-->
      <build-asset artifact-path="sdds3-repo" source-dir="sdds/bazel-bin/sdds3" mode="dev">
          <include glob="package/**"/>
          <include glob="suite/**"/>
          <include glob="supplement/**"/>
      </build-asset>
      <release-asset artifact-path="sdds3-launchdarkly" source-dir="sdds/output/launchdarkly" mode="dev">
          <include glob="*.json"/>
      </release-asset>
      <!--999 version-->
      <build-asset artifact-path="sdds3-repo-999" source-dir="sdds/bazel-bin/sdds3" mode="999">
          <include glob="package/**"/>
          <include glob="suite/**"/>
          <include glob="supplement/**"/>
      </build-asset>
      <release-asset artifact-path="sdds3-launchdarkly-999" source-dir="sdds/output/launchdarkly" mode="999">
          <include glob="*.json"/>
      </release-asset>
      <!--prod version-->
      <release-asset artifact-path="prod-sdds3-repo" source-dir="sdds/bazel-bin/sdds3" mode="prod">
          <include glob="package/**"/>
          <include glob="suite/**"/>
      </release-asset>
      <release-asset artifact-path="prod-sdds3-launchdarkly" source-dir="sdds/output/launchdarkly" mode="prod">
          <include glob="*.json"/>
      </release-asset>
      <release-asset artifact-path="prod-sdds3-static-suites" source-dir="sdds/output/prod-sdds3-static-suites" mode="prod,dev">
          <include glob="*.json"/>
      </release-asset>
      <release-asset artifact-path="prod-sdds3-static-suites-999" source-dir="sdds/output/prod-sdds3-static-suites" mode="999">
          <include glob="*.json"/>
      </release-asset>
  </publish>
</package>