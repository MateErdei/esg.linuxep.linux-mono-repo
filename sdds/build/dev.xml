<?xml version="1.0" encoding="utf-8"?>
<package
  name="sspl-warehouse"
  version="1.0.0">

  <!-- Components are fetched directly by the warehouse generation scripts according to the specs in the
         warehouse definition file. These inputs are the tools that are needed and a couple of oddball
         components.

         All modes:
          release-package
          release-package-edr-999
          release-package-mdr-999
          release-package-edr-mdr-999
    -->

    <inputs>
      <workingdir>.</workingdir>

      <build-asset project="linuxep" repo="everest-base" mode="release-package,release-package-query-pack,release-package-base-999,release-package-edr-999,release-package-mdr-999,release-package-edr-mdr-999,release-package-060,dev,999">
        <development-version branch="develop"/>
          <include artifact-path="sspl-base/SDDS3-PACKAGE" dest-dir="redist/base/latest/x64" mode="dev"/>
          <include artifact-path="sspl-base/RA-SDDS3-PACKAGE" dest-dir="redist/responseactions/latest/x64" mode="dev"/>
          <include artifact-path="sspl-base-999/SDDS3-PACKAGE" dest-dir="redist/base/latest/x64" mode="999"/>
          <include artifact-path="sspl-base-999/RA-SDDS3-PACKAGE" dest-dir="redist/responseactions/latest/x64" mode="999"/>
      </build-asset>

      <build-asset project="linuxep" repo="runtimedetections" mode="release-package,release-package-query-pack,release-package-base-999,release-package-edr-999,release-package-mdr-999,release-package-edr-mdr-999,release-package-060,dev,999">
        <development-version branch="master"/>
          <include artifact-path="SDDS3-PACKAGE" dest-dir="redist/runtimedetections/latest/x64" mode="dev"/>
      </build-asset>
      
      <build-asset project="linuxep" repo="sspl-plugin-heartbeat" mode="release-package,release-package-query-pack,release-package-base-999,release-package-edr-999,release-package-mdr-999,release-package-edr-mdr-999,release-package-060,dev,999">
        <development-version branch="develop"/>
          <include artifact-path="sspl-plugin-heartbeat/SDDS3-PACKAGE" dest-dir="redist/heartbeat/latest/x64" mode="dev"/>
          <include artifact-path="sspl-plugin-heartbeat-999/SDDS3-PACKAGE" dest-dir="redist/heartbeat/latest/x64" mode="999"/>
      </build-asset>

      <build-asset project="winep" repo="liveterminal" mode="release-package,release-package-query-pack,release-package-base-999,release-package-edr-999,release-package-mdr-999,release-package-edr-mdr-999,release-package-060,dev,999">
        <development-version branch="develop"/>
        <include artifact-path="liveterminal/sdds" dest-dir="redist/liveterminal" mode="release-package,release-package-base-999,release-package-edr-999,release-package-mdr-999,release-package-060,release-package-query-pack"/>
        <include artifact-path="liveterminal-999/sdds" dest-dir="redist/liveterminal" mode="release-package-edr-mdr-999"/>
          <include artifact-path="liveterminal/SDDS3-PACKAGE" dest-dir="redist/liveresponse/latest/x64" mode="dev"/>
          <include artifact-path="liveterminal-999/SDDS3-PACKAGE" dest-dir="redist/liveresponse/latest/x64" mode="999"/>
      </build-asset>

      <build-asset project="linuxep" repo="sspl-plugin-edr-component" mode="release-package,release-package-query-pack,release-package-base-999,release-package-edr-999,release-package-mdr-999,release-package-edr-mdr-999,release-package-060,dev,999">
        <development-version branch="develop"/>
          <include artifact-path="edr/SDDS3-PACKAGE" dest-dir="redist/edr/latest/x64" mode="dev"/>
          <include artifact-path="edr-999/SDDS3-PACKAGE" dest-dir="redist/edr/latest/x64" mode="999"/>
      </build-asset>

    <build-asset project="linuxep" repo="sspl-plugin-event-journaler" mode="release-package,release-package-query-pack,release-package-base-999,release-package-edr-999,release-package-mdr-999,release-package-edr-mdr-999,release-package-060,dev,999">
        <development-version branch="develop"/>
        <include artifact-path="eventjournaler/SDDS3-PACKAGE" dest-dir="redist/event-journaler/latest/x64" mode="dev"/>
        <include artifact-path="eventjournaler-999/SDDS3-PACKAGE" dest-dir="redist/event-journaler/latest/x64" mode="999"/>
    </build-asset>

      <build-asset project="linuxep" repo="sspl-plugin-mdr-component" mode="release-package,release-package-query-pack,release-package-base-999,release-package-edr-999,release-package-mdr-999,release-package-edr-mdr-999,release-package-060,dev,999">
          <development-version branch="develop"/>
          <include artifact-path="mdr/SDDS3-PACKAGE" dest-dir="redist/mdr/latest/x64" mode="dev"/>
          <include artifact-path="mdr-999/SDDS3-PACKAGE" dest-dir="redist/mdr/latest/x64" mode="999"/>
      </build-asset>

      <build-asset project="linuxep" repo="sspl-plugin-anti-virus" mode="dev,999">
        <development-version branch="develop"/>
          <include artifact-path="sspl-plugin-anti-virus/SDDS3-PACKAGE" dest-dir="redist/av/latest/x64" mode="dev"/>
          <include artifact-path="sspl-plugin-anti-virus-999/SDDS3-PACKAGE" dest-dir="redist/av/latest/x64" mode="999"/>
      </build-asset>


        <!--supplements-->
        <build-asset project="linuxep" repo="runtimedetections" mode="dev,999,prod">
            <release-version branch="release--content--version_5_4_0" build-id="20230126175443-bdfb2d342160abcf3aedd03d1c39a3a9114b7f4a-IpTd6n"/>
            <development-version branch="master"/>
            <include artifact-path="sspl-rdrules-scit" dest-dir="inputs/supplements/RuntimeDetectionRules"/>
        </build-asset>
      <build-asset project="em" repo="esg" >
          <release-version branch="release/scheduled_query_pack/1.13" build-id="20220824140550-05ec7c0da54e978fa40839ee052374983a4a057a-JbkaIM"/>
          <development-version branch="develop" />
          <include artifact-path="scheduled-query-pack-sdds" dest-dir="redist/scheduled-query-pack-sdds" mode="release-package-mdr-999,release-package-edr-mdr-999,release-package-060,release-package-edr-999,release-package,release-package-base-999"/>
          <include artifact-path="scheduled-query-pack-scit" dest-dir="inputs/supplements/scheduled-query-pack" mode="dev,prod,999"/>
      </build-asset>
        <build-asset project="linuxep" repo="sspl-flags">
            <release-version branch="release/2023-1" build-id="20221110132249-4d8f64b248ffbad913fae69834246afcbbcedab6-c2UMnV"/>
            <development-version branch="develop"/>
            <include artifact-path="sspl-flags/scit-supplement" dest-dir="inputs/supplements/sspl-flags" mode="dev,999,prod"/>
            <include artifact-path="sspl-flags/SDDS-SSPL-FLAGS" dest-dir="redist/flags2" mode="release-package-mdr-999,release-package-edr-mdr-999,release-package-060,release-package-edr-999,release-package,release-package-base-999,release-package-query-pack"/>
        </build-asset>

        <!-- Use a different branch to test that the query back is changed on upgrading the
        query pack in develop should be different to the one in release branch chosen here-->
        <build-asset project="em" repo="esg" mode="release-package-query-pack">
            <development-version branch="release/2020.41-querypack"/>
            <include artifact-path="scheduled-query-pack-sdds" dest-dir="redist/scheduled-query-pack-sdds"/>
        </build-asset>
      <!-- release-packageonly -->
      <build-asset project="linuxep" repo="sspl-plugin-edr-componentsuite" mode="release-package-mdr-999,release-package-edr-mdr-999,release-package-060,release-package-edr-999,release-package,release-package-base-999,release-package-query-pack">
        <development-version branch="develop"/>
        <include artifact-path="sspl-componentsuite/SDDS-SSPL-COMPONENT-SUITE" dest-dir="redist/sspl-plugin-edr-componentsuite"/>
      </build-asset>

        <!-- sdds3 only-->
        <build-asset project="em" repo="esg">
            <!-- Import a specific release version of SDDS3 tools, because we don't want the sdds3 repo rebuilding for each SAU build. -->
            <release-version branch="release--2023.10--preview" build-id="20230225185802-92ad3bcdf323b7281e8700669aa98a6fcafc15b1-TfWKHy"/>
            <!-- Temp change to test new versions -->
<!--            <development-version branch="develop"/>-->
            <include artifact-path="bazel-tools" dest-dir="." />
            <include artifact-path="sophlib/sdds3-tools-x64-linux" dest-dir="redist/sdds3"/>
        </build-asset>
        <!-- gcc -->
        <build-asset project="thirdparty" repo="gcc">
            <release-version branch="release/Version_11_2_0" build-id="20220310091547-cf8f7ca9572a3bc9a68f05138086815341a49224-cZ84iF"/>
            <include artifact-path="output" dest-dir="redist/gcc" mode="dev,999,prod"/>
        </build-asset>
        <trusted-asset artifact-path="filer5-migrate/sddsimportgen/1-0-12/214456/sddsimportgen" dest-dir="./linuxep_suites" mode="dev,999,prod"/>
    </inputs>

    <buildcommands>
    <command mode="dev,999,prod">
        <program>python3</program>
        <args>makesuites.py</args>
        <workingdir>./linuxep_suites</workingdir>
    </command>
    <command mode="dev,999,prod">
        <program>/bin/bash</program>
        <args>sdds3/setup.sh</args>
        <workingdir>.</workingdir>
    </command>
    <command mode="dev,999,prod">
        <program>python3</program>
        <args>-u tools/src/dump_environment/dump_environment.py</args>
        <workingdir>.</workingdir>
    </command>
    <command mode="dev,999">
        <program>python3</program>
        <args>-u sdds3/tools/gen_bazel.py</args>
        <workingdir>.</workingdir>
    </command>
    <command mode="prod">
        <program>python3</program>
        <args>-u sdds3/tools/gen_bazel.py --mode prod</args>
        <workingdir>.</workingdir>
    </command>
    <command mode="dev,999,prod">
        <program>bazel</program>
        <args>build //sdds3/... --verbose_failures --spawn_strategy=standalone --distdir /opt/distdir</args>
        <workingdir>.</workingdir>
    </command>
    </buildcommands>
    <signingexclusions>
        <promotedfile name="dummy.bpf.o"/>
        <promotedfile name="task.bpf.o"/>
    </signingexclusions>
  <publish>
      <!--sdds3-->
      <!--dev version-->
      <build-asset artifact-path="sdds3-repo" source-dir="bazel-out/k8-fastbuild/bin/sdds3" mode="dev">
          <include glob="package/**"/>
          <include glob="suite/**"/>
          <include glob="supplement/**"/>
          <include glob="supplement_package/**"/>
      </build-asset>
      <release-asset artifact-path="sdds3-launchdarkly" source-dir="output/launchdarkly" mode="dev">
          <include glob="*.json"/>
      </release-asset>
      <!--999 version-->
      <build-asset artifact-path="sdds3-repo-999" source-dir="bazel-out/k8-fastbuild/bin/sdds3" mode="999">
          <include glob="package/**"/>
          <include glob="suite/**"/>
          <include glob="supplement/**"/>
          <include glob="supplement_package/**"/>
      </build-asset>
      <release-asset artifact-path="sdds3-launchdarkly-999" source-dir="output/launchdarkly" mode="999">
          <include glob="*.json"/>
      </release-asset>
      <!--prod version-->
      <release-asset artifact-path="prod-sdds3-repo" source-dir="bazel-out/k8-fastbuild/bin/sdds3" mode="prod">
          <include glob="package/**"/>
          <include glob="suite/**"/>
      </release-asset>
      <release-asset artifact-path="prod-sdds3-launchdarkly" source-dir="output/launchdarkly" mode="prod">
          <include glob="*.json"/>
      </release-asset>

      <!--release-package-->
    <build-asset artifact-path="base-999/warehouse" source-dir="output\warehouse\content" mode="release-package-base-999"/>
    <build-asset artifact-path="base-999/customer" source-dir="output\warehouse\customer" mode="release-package-base-999"/>
    <build-asset artifact-path="base-999/def" source-dir="output\def" mode="release-package-base-999"/>
    <build-asset artifact-path="base-999/logs" source-dir="logs" mode="release-package-base-999"/>

    <build-asset artifact-path="edr-999/warehouse" source-dir="output\warehouse\content" mode="release-package-edr-999"/>
    <build-asset artifact-path="edr-999/customer" source-dir="output\warehouse\customer" mode="release-package-edr-999"/>
    <build-asset artifact-path="edr-999/def" source-dir="output\def" mode="release-package-edr-999"/>
    <build-asset artifact-path="edr-999/logs" source-dir="logs" mode="release-package-edr-999"/>

    <build-asset artifact-path="edr-mdr-999/warehouse" source-dir="output\warehouse\content" mode="release-package-edr-mdr-999"/>
    <build-asset artifact-path="edr-mdr-999/customer" source-dir="output\warehouse\customer" mode="release-package-edr-mdr-999"/>
    <build-asset artifact-path="edr-mdr-999/def" source-dir="output\def" mode="release-package-edr-mdr-999"/>
    <build-asset artifact-path="edr-mdr-999/logs" source-dir="logs" mode="release-package-edr-mdr-999"/>

    <build-asset artifact-path="mdr-999/warehouse" source-dir="output\warehouse\content" mode="release-package-mdr-999"/>
    <build-asset artifact-path="mdr-999/customer" source-dir="output\warehouse\customer" mode="release-package-mdr-999"/>
    <build-asset artifact-path="mdr-999/def" source-dir="output\def" mode="release-package-mdr-999"/>
    <build-asset artifact-path="mdr-999/logs" source-dir="logs" mode="release-package-mdr-999"/>
  </publish>

</package>
