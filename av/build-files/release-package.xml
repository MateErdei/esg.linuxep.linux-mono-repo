<?xml version="1.0" encoding="utf-8"?>
<package name="sspl-plugin-anti-virus" version="0.5.0">
    <versioning>
        <workingdir>./products/distribution/include/AutoVersioningHeaders</workingdir>
    </versioning>

    <inputs>
        <workingdir>.</workingdir>
        <!-- DIFF SEPARATION COMMENT -->
        <!--Plugin Api Candidate Build - Change values below to match the latest Candidate build of base.
            -->
        <build-asset project="linuxep" repo="everest-base">
            <release-version branch="release/2020-41" build-id="20201002110606-fcf1821d6b71a2656471bd0abe151a1f40663fe4-qrruwT" />
            <include artifact-path="sspl-base/pluginapi" dest-dir="input" />
            <include artifact-path="sspl-base/SDDS-COMPONENT" dest-dir="input/base-sdds" />
        </build-asset>

        <package name="boostlinux11" version="1-72-0-39/220673/output" dest="input">
            <include src="boost.tar" dest="."/>
        </package>
        <package name="cmakelinux" version="3-11-2-4/213056/cmakelinux" dest="input">
            <include src="cmake-3.11.2-linux.tar.gz" dest="."/>
        </package>
        <package name="gcclinux" version="8-1-0-43/213047/gcclinux" dest="input">
            <include src="gcc-8.1.0-linux.tar.gz" dest="."/>
        </package>
        <package name="googletest" version="1-8-1/EES-8928" dest="input">
            <include src="googletest-release-1.8.1.tar.gz" dest="."/>
        </package>
        <!-- Need to compile our own messages -->
        <package name="capnprotolinux11" version="0-7-0-29/213995/output" dest="input">
            <include src="capnproto.tar" dest="."/>
        </package>
        <package name="openssllinux11" version="1-1-1g-6/219531/output" dest="input">
            <include src="openssl.tar" dest="."/>
        </package>

        <!-- SUSI imports -->

        <package name="libsavi-packages" internal_name="savi" version="3-78-6/218487" dest="input/susi_input" >
            <include src="packages/linux.amd64.glibc.2.3-gcc4.8.1/libsavi.so.3.*" dest="libsavi" />
            <include src="packages/linux.amd64.glibc.2.3-gcc4.8.1/libssp.so.0" dest="libsavi"  />
        </package>

        <package name="model-linux-x64" version="1-3/212025" dest="input/susi_input" >
            <include src="oempackage/linux-x64-model-gcc4.8.1.tar" dest="mllib"  />
        </package>

        <package name="liblocalrep-linux-x86_64" version="1-0/212029" dest="input/susi_input" >
            <include src="release/liblocalrep.so" dest="lrlib" />
        </package>

        <package name="libsophtainer-linuxamd64-glibc2_3" internal_name="libsophtainer" version="1-0-0/218312" dest="input/susi_input" >
            <include src="package/libsophtainer.tar" dest="libsophtainer" />
        </package>

        <!-- See https://esg-ci.eng.sophos/docs/docs/build-package-file#inputs-from-other-unified-pipelines-21 -->
<!--        <package name="susi" version="1-0-0-4589/221205" dest="input/susi_input" >-->
<!--            <include src="release/susi-centos7-x64-gcc810/lib" dest="susi/lib"/>-->
<!--            <include src="release/susi-centos7-x64-gcc810/include" dest="susi/include"/>-->
<!--        </package>-->
<!--        <package name="susi" version="1-0-0-4498/221037" dest="input/susi_input" >-->
<!--            <include src="rules/rules" dest="rules" />-->
<!--        </package>-->
        <build-asset project="ec" repo="susi">
            <release-version branch="release/test" build-id="20201001100919-a814d4a9e702db94e86f7848f41c2d6e16c26fdb-ptVCKg"/>
            <include artifact-path="release/centos7/libsusi" dest-dir="input/susi_input/susi/lib" />
            <include artifact-path="release/centos7/include" dest-dir="input/susi_input/susi/include" />
            <include artifact-path="release/rules" dest-dir="input/susi_input/rules" />
        </build-asset>

<!--        <package name="httpsrequester" version="1-0-0-757/221146" dest="input/susi_input" >-->
<!--            <include src="release/libglobalrep-centos7-x64-gcc810/lib" dest="gr/lib"/>-->
<!--        </package>-->

        <build-asset project="core" repo="httpsrequester">
            <release-version branch="release/test" build-id="20200918094111-0d8d9dc53765f2049f83090bd18c1672589374c5-vwPQEK"/>
            <include artifact-path="release/centos7/libglobalrep" dest-dir="input/susi_input/gr/lib"/>
        </build-asset>

        <!-- external dependencies -->
        <package name="openssl" version="1-1-1d-6/219246" dest="input/susi_input" >
            <include src="release/lib" dest="openssl/lib" />
        </package>

        <package name="boost" version="1-69-0-93/219328" dest="input/susi_input" >
            <include src="release/boost.tar.bz2" dest="boost" />
        </package>

        <package name="icu" version="64-2-50/219250"  dest="input/susi_input" >
            <include src="lib/libicudata.so.64.*" dest="icu/lib" />
            <include src="lib/libicui18n.so.64.*" dest="icu/lib" />
            <include src="lib/libicuuc.so.64.*" dest="icu/lib"/>
        </package>

        <package name="libarchive" version="64-2-7/219360" dest="input/susi_input" >
            <include src="lib/libarchive.so.13.*" dest="libarchive/lib" />
        </package>

        <package name="luajit" version="2-0-5-52/219247" dest="input/susi_input" >
            <include src="lib/libluajit-5.1.so.*" dest="luajit/lib" />
        </package>

    </inputs>
    <buildcommands>
        <command mode="release,oldci">
            <program>/bin/bash</program>
            <args>./build.sh --ci --name av</args>
            <workingdir>.</workingdir>
        </command>
        <command mode="debug">
            <program>/bin/bash</program>
            <args>./build.sh --ci --name av --debug</args>
            <workingdir>.</workingdir>
        </command>
        <command mode="coverage">
            <program>/bin/bash</program>
            <args>./build.sh --ci --name av --esg-ci-coverage</args>
            <workingdir>.</workingdir>
        </command>
    </buildcommands>
    <publish>
        <workingdir>.</workingdir>
        <destdir>sspl-plugin-anti-virus</destdir>

        <release-asset artifact-path="sspl-plugin-anti-virus/SDDS-COMPONENT" source-dir="output/SDDS-COMPONENT" mode="release"/>
        <build-asset artifact-path="output" source-dir="output" mode="release,debug">
        </build-asset>
        <build-asset artifact-path="coverage" source-dir="output" mode="coverage">
        </build-asset>
        <logs name="build_log" source-dir="log" mode="debug,release" />
        <logs name="coverage_log" source-dir="log" mode="coverage" />

        <buildoutputs>
            <!-- rename logs for coverage builds -->
            <output name="build_log" srcfolder="log" mode="oldci"> </output>
            <output name="coverage_log" srcfolder="log" mode="oldcoverage"> </output>

            <!-- rename output for coverage builds -->
            <output name="output" srcfolder="output" artifactpath="output" mode="oldci"> </output>
        </buildoutputs>
        <publishbranches>master,develop,bugfix/fix_coverage</publishbranches>
    </publish>
</package>
