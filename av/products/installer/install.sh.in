#!/usr/bin/env bash

# Copyright 2018 Sophos Limited.  All rights reserved.

PLUGIN_NAME=@PLUGIN_NAME@
PRODUCT_LINE_ID="@PRODUCT_LINE_ID@"

EXIT_FAIL_CREATE_DIRECTORY=10
EXIT_FAIL_FIND_GROUPADD=11
EXIT_FAIL_ADD_GROUP=12
EXIT_FAIL_FIND_USERADD=13
EXIT_FAIL_ADDUSER=14
EXIT_FAIL_FIND_GETENT=15
EXIT_FAIL_WDCTL_FAILED_TO_COPY=16
EXIT_FAIL_WDCTL_FAILED_TO_START=17
EXIT_FAIL_VERSIONEDCOPY=20
EXIT_FAIL_INSTALL_PACKAGE=21

STARTINGDIR=$(pwd)
SCRIPTDIR=${0%/*}
if [[ "$SCRIPTDIR" == "$0" ]]
then
    SCRIPTDIR=${STARTINGDIR}
fi

ABS_SCRIPTDIR=$(cd $SCRIPTDIR && pwd)

[[ -n "$SOPHOS_INSTALL" ]] || SOPHOS_INSTALL=/opt/sophos-spl
[[ -n "$DIST" ]] || DIST=$ABS_SCRIPTDIR

failure()
{
    local CODE=$1
    shift
    echo "$@" >&2
    exit $CODE
}
export DIST
export SOPHOS_INSTALL
export LD_LIBRARY_PATH="$SOPHOS_INSTALL/base/lib64"

USER_NAME=sophos-spl-user
GROUP_NAME=sophos-spl-group

#In case this is an upgrade request the watchdog stops the plugin
#A failure with exit code 2 will be ignored as this just means the plugin was not registered
#This could happen if a plugin is being freshly installed (e.g. for the first time)
"${SOPHOS_INSTALL}/bin/wdctl" stop "${PLUGIN_NAME}" &>/dev/null || [ $? == 2 ] || echo Failed to stop plugin: ${PLUGIN_NAME}

[[ -d $SOPHOS_INSTALL ]] || failure ${EXIT_FAIL_CREATE_DIRECTORY} "Failed to find installation directory: $SOPHOS_INSTALL"

#Create plugin registration file
TEMP_REG_FILE=${SOPHOS_INSTALL}/tmp/${PLUGIN_NAME}.json
sed "s;SOPHOS_INSTALL_VALUE;${SOPHOS_INSTALL};g" "${DIST}/files/base/pluginRegistry/${PLUGIN_NAME}.json" >  "${TEMP_REG_FILE}"
"${SOPHOS_INSTALL}/bin/wdctl" copyPluginRegistration "${TEMP_REG_FILE}" || failure ${EXIT_FAIL_WDCTL_FAILED_TO_COPY} "Failed to copy registration ${TEMP_REG_FILE}"
rm -f ${TEMP_REG_FILE}

# Use a safe umask while copying files before correcting permissions
umask 077

#Install files
for F in $(find $DIST/files/plugins -type f)
do
    $SOPHOS_INSTALL/base/bin/versionedcopy $F || failure ${EXIT_FAIL_VERSIONEDCOPY} "Failed to copy $F to installation"
done

ln -s -f "${SOPHOS_INSTALL}/plugins/${PLUGIN_NAME}/sbin/uninstall.sh" "${SOPHOS_INSTALL}/base/update/var/installedproducts/${PRODUCT_LINE_ID}.sh"

chmod 0711 "${SOPHOS_INSTALL}/plugins/${PLUGIN_NAME}"
chmod 0711 "${SOPHOS_INSTALL}/plugins/${PLUGIN_NAME}/lib64"
chmod 0755 "${SOPHOS_INSTALL}/plugins/${PLUGIN_NAME}/lib64"/*
# Lock down libraries which are not needed by avscanner
chmod 0700 "${SOPHOS_INSTALL}/plugins/${PLUGIN_NAME}/lib64/libpluginimpl.so"*
chmod 0700 "${SOPHOS_INSTALL}/plugins/${PLUGIN_NAME}/lib64/libscanscheduler.so"*
chmod 0700 "${SOPHOS_INSTALL}/plugins/${PLUGIN_NAME}/lib64/libsophosthreatdetectorimpl.so"*
chmod 0700 "${SOPHOS_INSTALL}/plugins/${PLUGIN_NAME}/lib64/libthreat_scanner.so"*
chmod 0711 "${SOPHOS_INSTALL}/plugins/${PLUGIN_NAME}/bin"
chmod 0755 "${SOPHOS_INSTALL}/plugins/${PLUGIN_NAME}/bin/avscanner"
chmod -R 0710 "${SOPHOS_INSTALL}/plugins/${PLUGIN_NAME}/sbin"

VAR="${SOPHOS_INSTALL}/plugins/${PLUGIN_NAME}/var"
mkdir -p "$VAR"

CHROOT="${SOPHOS_INSTALL}/plugins/${PLUGIN_NAME}/chroot"
CHROOT_LINK_DIR="${CHROOT}/${SOPHOS_INSTALL}/plugins/${PLUGIN_NAME}"
mkdir -p ${CHROOT_LINK_DIR}
ln -snf / ${CHROOT_LINK_DIR}/chroot
mkdir -p ${CHROOT}/${SOPHOS_INSTALL}/base/etc/
mkdir -p ${CHROOT}/${SOPHOS_INSTALL}/base/mcs/policy/
mkdir -p ${CHROOT}/tmp
chmod 0711 "$CHROOT"

## Create log directory symlinks for sophos_threat_detector
mkdir -p "$CHROOT/log" "${SOPHOS_INSTALL}/plugins/${PLUGIN_NAME}/log" "${CHROOT_LINK_DIR}/log"
ln -snf "$CHROOT/log" "${SOPHOS_INSTALL}/plugins/${PLUGIN_NAME}/log/sophos_threat_detector"
ln -snf "/log" "${CHROOT_LINK_DIR}/log/sophos_threat_detector"
ln -snf "sophos_threat_detector/sophos_threat_detector.log" "${SOPHOS_INSTALL}/plugins/${PLUGIN_NAME}/log/sophos_threat_detector.log"

## Temporary - will need to adapt to hot-updating in SuSI
cp ${SOPHOS_INSTALL}/base/lib64/libz.so.1 ${CHROOT}/susi/distribution_version/version1/

# Enable DNS resolve on Ubuntu
mkdir -p ${CHROOT}/etc ${CHROOT}/susi/distribution_version

chown -R ${USER_NAME}:${GROUP_NAME} "${SOPHOS_INSTALL}/plugins/${PLUGIN_NAME}"

if [[ ! -x $(which setcap) ]]
then
    echo "Installing setcap"
    if [[ -x $(which apt) ]]
    then
        apt install -y libcap2-bin || failure ${EXIT_FAIL_INSTALL_PACKAGE} "Failed to install libcap2-bin"
    elif [[ -x $(which yum) ]]
    then
        failure ${EXIT_FAIL_INSTALL_PACKAGE} "Unable to install setcap using yum"
    else
        failure ${EXIT_FAIL_INSTALL_PACKAGE} "Unable to install setcap"
    fi
fi


pushd "${SOPHOS_INSTALL}/plugins/${PLUGIN_NAME}/sbin" || failure ${EXIT_FAIL_CREATE_DIRECTORY} "Failed to find sbin directory"
THREAT_DETECTOR="sophos_threat_detector_launcher"
[[ -h "$THREAT_DETECTOR" ]] && THREAT_DETECTOR=$(readlink "$THREAT_DETECTOR")
[[ -f "$THREAT_DETECTOR" ]] && setcap cap_sys_chroot=eip "$THREAT_DETECTOR"
SCHEDULED_FILE_WALKER="scheduled_file_walker_launcher"
[[ -h "$SCHEDULED_FILE_WALKER" ]] && SCHEDULED_FILE_WALKER=$(readlink "$SCHEDULED_FILE_WALKER")
[[ -f "$SCHEDULED_FILE_WALKER" ]] && setcap cap_dac_read_search=eip "$SCHEDULED_FILE_WALKER"
popd || failure ${EXIT_FAIL_CREATE_DIRECTORY} "Failed to return from sbin directory"

ln -snf "${SOPHOS_INSTALL}/plugins/${PLUGIN_NAME}/bin/avscanner" /usr/local/bin/avscanner

#After install start the plugin
"${SOPHOS_INSTALL}/bin/wdctl" start "${PLUGIN_NAME}" || failure ${EXIT_FAIL_WDCTL_FAILED_TO_START} "Failed to start plugin ${PLUGIN_NAME}"
