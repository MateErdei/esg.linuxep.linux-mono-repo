{
  "amazonlinux2x64" : {
    "Type" : "AWS::EC2::Instance",
    "Condition" :  "RunAmazonLinux2x64" ,
    "Properties" : {
      "IamInstanceProfile": { "Ref": "RegressionTestInstanceProfile" },
      "KeyName" : { "Ref" : "KeyName" },
      "ImageId" : "ami-017c823f93dca4eb3",
      "InstanceType": "c4.large",
      "InstanceInitiatedShutdownBehavior": "terminate",
      "Tags" : [
        {"Key" : "TestPassUUID", "Value" : { "Ref" : "TestPassUUID" } },
        {"Key" : "OwnerName", "Value" : "ukdevlinuxdarwin"},
        {"Key" : "OwnerEmail", "Value" : "ukdevlinuxdarwin@sophos.com"},
        {"Key" : "SupportEmail", "Value" : "ukdevlinuxdarwin@sophos.com"},
        {"Key" : "BusinessUnit", "Value" : "ESG"},
        {"Key" : "CostCentre", "Value" : "GB11601200"},
        {"Key" : "Project", "Value" : "XDR"},
        {"Key" : "Application", "Value" : "linux-endpoint-testing"},
        {"Key" : "BaseAmi", "Value" : "ami-089ccabb305c2f6e0"},
        {"Key" : "Environment", "Value" : "development"},
        {"Key" : "AutomationExcluded", "Value" : "true"},
        {"Key" : "SecurityClassification", "Value" : "none low"},
        {"Key" : "TestImage", "Value" : "true"},
        {"Key" : "Codeline", "Value" : "SSPL" },
        {"Key" : "Branch", "Value" : "SSPL" },
        {"Key" : "Name", "Value" : "amazonlinux2x64" },
        {"Key" : "RootStackname", "Value" : "SSPL" }
      ],
      "NetworkInterfaces" : [{
        "GroupSet"                 : [{ "Ref" : "SSPLsecurityGroup" }],
        "AssociatePublicIpAddress" : "true",
        "DeviceIndex"              : "0",
        "DeleteOnTermination"      : "true",
        "SubnetId"                 : { "Ref" : "Subnet1" }
      }],
      "UserData": { "Fn::Base64" : { "Fn::Join" : ["", [
        "#!/bin/bash\n",
        "echo 'Testing ", {"Ref": "BuildName"},"'\n",
        "echo 'Setting up the system for tests ...' >>/tmp/cloudFormationInit.log\n",
        "export HOSTNAME=@HOSTNAMEGOESHERE@", "\n",
        "nmcli general hostname ${HOSTNAME}\n",
        "hostnamectl set-hostname ${HOSTNAME}\n",
        "sed -i -e '/^HOSTNAME=/ s/=.*/='$HOSTNAME'/' /etc/sysconfig/network\n",
        "hostname ${HOSTNAME}\n",
        "echo $'#cloud-config\nhostname: '${HOSTNAME} $'\nfqdn: '${HOSTNAME} >/etc/cloud/cloud.cfg.d/99_hostname.cfg\n",
        "sed -i 's/127.0.0.1/127.0.0.1 '$HOSTNAME'/' /etc/hosts\n",
        "yum -y install ec2-instance-connect epel-release make gcc gcc-build python-devel nfs-utils kernel-devel fuse-libs gdb rpm-build cifs-utils wget attr psmisc sshpass gcc-c++ samba 2>&1 >>/tmp/cloudFormationInit.log\n",
        "yum -y install python-pip fuse-encfs inotify-tools python3-devel  python3-pip 2>&1 >>/tmp/cloudFormationInit.log\n",
        "pip3 install --upgrade robotframework psutil pytest-html pyzmq zmq protobuf paramiko watchdog cryptography==3.3.1 python-dateutil requests enum34 packaging Cython pycapnp 2>&1 >>/tmp/cloudFormationInit.log\n",
        "service rpcbind start 2>&1 >>/tmp/cloudFormationInit.log\n",
        "systemctl start nfs 2>&1 >>/tmp/cloudFormationInit.log\n",
        "systemctl status nfs-server.service 2>&1 >>/tmp/cloudFormationInit.log\n",
        "getenforce >>/tmp/cloudFormationInit.log\n",
        "export OVERRIDE_CLOUD_IP=", {"Ref": "cloudIpAddress"}, "\n",
        "echo ", {"Ref": "cloudIpAddress"}, " >/root/OVERRIDE_CLOUD_IP\n",
        "echo 'Created aws config. Now grabbing tests...' >> /tmp/cloudFormationInit.log\n",
        "echo 'Key passed from parent stack: ", { "Ref" : "KeyName" }, "' >> /tmp/cloudFormationInit.log\n",
        "aws s3 cp s3://sspl-testbucket/sspl/sspl-test-", { "Ref": "StackName" }, ".tgz /opt/sspl-test.tgz >> /tmp/cloudFormationInit.log 2>&1\n",
        "mkdir -p /opt/sspl >> /tmp/cloudFormationInit.log 2>&1\n",
        "tar xvzf /opt/sspl-test.tgz -C /opt/sspl >> /tmp/cloudFormationInit.log 2>&1\n",
        "mkdir -p '/uk-filer5/prodro/bir/savlinux9-package/10-5-0/217084/savlinux-package' >> /tmp/cloudFormationInit.log 2>&1\n",
        "cp /opt/sspl/sav* '/uk-filer5/prodro/bir/savlinux9-package/10-5-0/217084/savlinux-package' >> /tmp/cloudFormationInit.log 2>&1\n",
        "bash /opt/sspl/testAndSendResults.sh ", {"Ref": "StackName"}, " @ARGSGOHERE@ >> /tmp/cloudFormationInit.log 2>&1\n",
        "echo 'Finished.' >> /tmp/cloudFormationInit.log\n",
        "aws s3 cp /tmp/cloudFormationInit.log s3://sspl-testbucket/test-results/", { "Ref": "StackName" }, "/$HOSTNAME-cloudFormationInit.log\n",
        "poweroff\n"
      ]]}}
    }
  }
}