
library "standardPipeline"

project = 'sspl-edr-plugin'
version_key = '1.0.2'
project_gitrepo = 'ssh://git@stash.sophos.net:7999/linuxep/sspl-plugin-edr-component.git'
project_builddir = 'sspl-edr-plugin-build'
project_release_xml = 'build-files/release-package.xml'
buildAgentTemplate = 'JenkinsLinuxTemplate1'

properties([
  parameters([
    string(name: 'CommitHash', defaultValue: ''),
    string(name: 'PortalId', defaultValue: ''),
    string(name: 'PortalAddress', defaultValue: ''),
    string(name: 'Mode', defaultValue: 'release')
  ])
])

skipDefaultCheckout()
try{
	version_number = GetVersionNumber(version_key, project)
    PreBuild(params.CommitHash, params.PortalId, params.PortalAddress)

    git_branch = "${env.BRANCH_NAME}"
    echo git_branch
//  replace below with this when done testing  if (git_branch == 'master')
    if (git_branch.endsWith('coverity-to-the-edr-plugin'))
    {

        echo 'Starting edr master branch builds'
        parallel Build:
        {
            ArtisanBuild(
                params.CommitHash,
                params.PortalId,
                buildAgentTemplate,
                project_release_xml,
                params.Mode,
                version_number,
                project_builddir)

            SuccessfulBuild(
                params.CommitHash,
                params.PortalId,
                params.PortalAddress,
                'master',
                project_gitrepo,
                git_branch,
                project_release_xml)
        },
        coverage_build:
        {
            echo 'Starting coverage build'
            def build_image = DockerBuildImage(
                operatingSystem: 'Linux',
                dockerfileDirectoryPath: 'build/scripts',
                dockerfileName: 'docker/ESGCI_Dockerfile'
            )

            build_image.build(
                        pathToReleasePackage: project_release_xml,               // Path to package xml.
                        buildMode: 'coverage',                                                   // Build mode used by the package xml options e.g. for driving bullseye builds, coverity builds, 64-bit, 32-bit etc.
                        buildTimeOut: 30                                                        // Timeout in minutes.
                    )
            echo 'Finished coverage build'
        }
    }
    else
    {
        echo 'Starting ticket branch edr build'
        ArtisanBuild(buildAgentTemplate, project_release_xml, params.Mode, version_number, project_builddir)
        SuccessfulBuild(project_release_xml)
    }

} catch(e){
    FailedBuild(params.CommitHash, params.PortalId, params.PortalAddress)
    error("Build failed: " + e.toString())
}
